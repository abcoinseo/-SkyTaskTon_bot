<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTaskTon</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* Basic Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f8;
            color: #333;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        header {
            background-color: #007bff;
            color: white;
            padding: 1rem 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        header .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        nav ul {
            list-style: none;
            display: flex;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            padding: 10px;
            border-radius: 5px;
        }

        nav ul li a:hover,
        nav ul li a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Main Content Area */
        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align items to the top */
            padding: 20px;
            max-width: 1200px;
            margin: 20px auto;
            width: 100%;
        }

        section {
            display: none; /* Hidden by default */
            width: 100%;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        section.active {
            display: block;
        }

        /* Home Page */
        .task-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-card:hover {
            transform: translateY(-5px);
        }

        .task-details h3 {
            margin-bottom: 10px;
            color: #007bff;
        }

        .task-details p {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 5px;
        }

        .task-details .impression-count {
            font-size: 0.8rem;
            color: #777;
            margin-top: 10px;
        }

        .task-actions button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .task-actions button:hover {
            background-color: #218838;
        }

        .task-actions button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .timer {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Add Task Page */
        .add-task-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .add-task-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .add-task-form input[type="text"],
        .add-task-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .add-task-form textarea {
            min-height: 100px;
            resize: vertical;
        }

        .add-task-form button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
            width: fit-content;
        }

        .add-task-form button:hover {
            background-color: #0056b3;
        }

        /* Profile Page */
        .profile-section h2 {
            margin-bottom: 20px;
            color: #007bff;
        }

        .profile-info p {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .profile-info span {
            font-weight: bold;
            color: #333;
        }

        .balance-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .balance-info h3 {
            margin-bottom: 10px;
            color: #007bff;
        }

        .balance-info p {
            font-size: 1.2rem;
            font-weight: bold;
            color: #28a745; /* Green for balance */
        }

        .withdraw-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .withdraw-section h3 {
            margin-bottom: 15px;
            color: #dc3545; /* Red for withdrawal */
        }

        .withdraw-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: flex-end;
        }

        .withdraw-form div {
            display: flex;
            flex-direction: column;
        }

        .withdraw-form label {
            margin-bottom: 5px;
            font-weight: bold;
        }

        .withdraw-form input[type="number"],
        .withdraw-form input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .withdraw-form button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease;
            height: 42px; /* Match input height */
        }

        .withdraw-form button:hover {
            background-color: #c82333;
        }

        /* My Tasks Page */
        .task-list-container {
            margin-top: 20px;
        }

        .task-list-container h3 {
            margin-bottom: 15px;
            color: #007bff;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }

        .task-item span {
            flex-grow: 1;
            margin-right: 10px;
        }

        .task-item .status {
            font-style: italic;
            color: #6c757d;
            font-size: 0.9rem;
            margin-right: 15px;
        }

        .task-item .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.3s ease;
        }

        .task-item .delete-btn:hover {
            background-color: #c82333;
        }

        /* Ads Page */
        .ads-container {
            text-align: center;
            padding: 30px;
        }

        .ads-container h2 {
            margin-bottom: 20px;
            color: #007bff;
        }

        .ads-container p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #555;
        }

        .ads-container button {
            background-color: #ffc107; /* Warning yellow for ads */
            color: #212529;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .ads-container button:hover {
            background-color: #e0a800;
        }

        .ads-container button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .ad-placeholder {
            width: 100%;
            height: 150px;
            background-color: #e9ecef;
            border-radius: 8px;
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #6c757d;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                padding: 1rem;
            }
            nav ul {
                margin-top: 10px;
            }
            nav ul li {
                margin: 0 10px;
            }
            main {
                padding: 10px;
            }
            .task-card {
                flex-direction: column;
                align-items: flex-start;
            }
            .task-actions {
                margin-top: 15px;
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }
            .withdraw-form {
                grid-template-columns: 1fr;
            }
            .withdraw-form button {
                width: 100%;
            }
        }

        /* Popup for withdrawal */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .popup-content h3 {
            margin-bottom: 20px;
            color: #007bff;
        }

        .popup-content .popup-input {
            width: calc(100% - 20px); /* Account for padding */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .popup-content .popup-actions button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        .popup-content .popup-actions button:hover {
            background-color: #0056b3;
        }

        .popup-content .close-btn {
            background-color: #6c757d;
        }

        .popup-content .close-btn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">SkyTaskTon</div>
        <nav>
            <ul>
                <li><a href="#" id="nav-home" class="active">Home</a></li>
                <li><a href="#" id="nav-profile">Profile</a></li>
                <li><a href="#" id="nav-add-task">Add Task</a></li>
                <li><a href="#" id="nav-my-tasks">My Tasks</a></li>
                <li><a href="#" id="nav-ads">Ads</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Home Section -->
        <section id="home-section" class="active">
            <h2>Available Tasks</h2>
            <div id="task-list">
                <!-- Task cards will be loaded here -->
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section">
            <h2>User Profile</h2>
            <div class="profile-info">
                <p>Telegram ID: <span id="profile-telegram-id">N/A</span></p>
                <p>Username: <span id="profile-username">N/A</span></p>
                <p>Total Tasks Completed: <span id="profile-tasks-completed">0</span></p>
                <p>Total Impressions Earned: <span id="profile-total-impressions">0</span></p>
            </div>
            <div class="balance-info">
                <h3>Your Balance</h3>
                <p id="profile-balance">0.00000 TON</p>
            </div>

            <div class="withdraw-section">
                <h3>Withdrawal</h3>
                <div class="withdraw-form">
                    <div>
                        <label for="withdraw-amount">Amount (TON)</label>
                        <input type="number" id="withdraw-amount" placeholder="Enter amount" min="0.1" step="0.00001">
                    </div>
                    <div>
                        <label for="withdraw-address">TON Address</label>
                        <input type="text" id="withdraw-address" placeholder="Your TON wallet address">
                    </div>
                    <button id="request-withdraw-btn">Request Withdrawal</button>
                </div>
                <div class="history-section">
                    <h3>Withdrawal History</h3>
                    <ul id="withdrawal-history">
                        <!-- Withdrawal history will be loaded here -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- Add Task Section -->
        <section id="add-task-section">
            <h2>Add New Task</h2>
            <form id="add-task-form" class="add-task-form">
                <div>
                    <label for="task-title">Task Title:</label>
                    <input type="text" id="task-title" required>
                </div>
                <div>
                    <label for="task-description">Task Description:</label>
                    <textarea id="task-description" required></textarea>
                </div>
                <div>
                    <label for="task-url">Task URL:</label>
                    <input type="text" id="task-url" required>
                </div>
                <div>
                    <label for="task-impressions">Minimum Impressions (e.g., 500):</label>
                    <input type="number" id="task-impressions" value="500" min="1" required>
                </div>
                <div>
                    <label for="task-star-cost">TG Stars Cost (e.g., 100):</label>
                    <input type="number" id="task-star-cost" value="100" min="1" required>
                </div>
                <button type="submit">Add Task</button>
            </form>
        </section>

        <!-- My Tasks Section -->
        <section id="my-tasks-section">
            <h2>My Tasks</h2>
            <div class="task-list-container">
                <h3>Running Tasks</h3>
                <ul id="running-tasks-list">
                    <!-- Running tasks will be loaded here -->
                </ul>
                <h3>Completed Tasks</h3>
                <ul id="completed-tasks-list">
                    <!-- Completed tasks will be loaded here -->
                </ul>
                <div class="summary-stats">
                    <p>Total Users Completed: <span id="total-users-completed">0</span></p>
                    <p>Total Impressions Completed: <span id="total-impressions-completed">0</span></p>
                </div>
            </div>
        </section>

        <!-- Ads Section -->
        <section id="ads-section">
            <h2>Earn with Ads</h2>
            <p>Watch ads to earn a small amount of TON.</p>
            <p>You can watch up to 10 ads per day.</p>
            <button id="watch-ad-btn">Watch Ad</button>
            <div class="ad-placeholder">
                <span id="ad-status">No ad loaded yet. Click 'Watch Ad'.</span>
                <!-- Ad content will be dynamically loaded here -->
            </div>
            <p id="daily-ad-limit-message" style="color: red; display: none;">You have reached your daily ad limit.</p>
        </section>
    </main>

    <!-- Withdrawal Confirmation Popup -->
    <div id="withdraw-confirm-popup" class="popup-overlay">
        <div class="popup-content">
            <h3>Confirm Withdrawal</h3>
            <p>Amount: <span id="popup-amount"></span> TON</p>
            <p>Address: <span id="popup-address"></span></p>
            <div class="popup-actions">
                <button id="confirm-withdraw-btn">Confirm</button>
                <button id="cancel-withdraw-btn" class="close-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9789409' data-sdk='show_9789409'></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBSj3t2ClyafHRgpN__cCnbDarhTfse3aA", // **IMPORTANT: DO NOT SHARE THIS PUBLICLY IN PRODUCTION!**
            authDomain: "skytasktonbot.firebaseapp.com",
            projectId: "skytasktonbot",
            storageBucket: "skytasktonbot.firebasestorage.app",
            messagingSenderId: "1078897344814",
            appId: "1:1078897344814:web:166f4341b884d877d97abf"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Telegram Web App Integration (Simulated) ---
        // In a real Telegram Bot Web App, you would get this from the Telegram SDK.
        // For this single HTML file, we'll simulate it.
        const telegramUser = {
            id: 123456789, // Example Telegram User ID
            username: "example_user", // Example Username
            first_name: "Example",
            last_name: "User"
        };

        // --- DOM Elements ---
        const navLinks = document.querySelectorAll('nav a');
        const sections = document.querySelectorAll('section');
        const taskListDiv = document.getElementById('task-list');
        const addTaskForm = document.getElementById('add-task-form');
        const profileTelegramIdSpan = document.getElementById('profile-telegram-id');
        const profileUsernameSpan = document.getElementById('profile-username');
        const profileTasksCompletedSpan = document.getElementById('profile-tasks-completed');
        const profileTotalImpressionsSpan = document.getElementById('profile-total-impressions');
        const profileBalanceSpan = document.getElementById('profile-balance');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawAddressInput = document.getElementById('withdraw-address');
        const requestWithdrawBtn = document.getElementById('request-withdraw-btn');
        const withdrawalHistoryList = document.getElementById('withdrawal-history');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const adStatusSpan = document.getElementById('ad-status');
        const dailyAdLimitMessage = document.getElementById('daily-ad-limit-message');

        // Profile and task related elements
        const runningTasksList = document.getElementById('running-tasks-list');
        const completedTasksList = document.getElementById('completed-tasks-list');
        const totalUsersCompletedSpan = document.getElementById('total-users-completed');
        const totalImpressionsCompletedSpan = document.getElementById('total-impressions-completed');

        // Withdrawal Popup elements
        const withdrawConfirmPopup = document.getElementById('withdraw-confirm-popup');
        const popupAmountSpan = document.getElementById('popup-amount');
        const popupAddressSpan = document.getElementById('popup-address');
        const confirmWithdrawBtn = document.getElementById('confirm-withdraw-btn');
        const cancelWithdrawBtn = document.getElementById('cancel-withdraw-btn');

        // --- State Variables ---
        let currentBalance = 0;
        let tasks = []; // Array to hold all tasks
        let userTasks = []; // Array to hold tasks assigned to the current user
        let dailyAdCount = 0;
        const MAX_DAILY_ADS = 10;
        const AD_EARNING = 0.000001;
        const TASK_EARNING = 0.000005; // 0.000005 TON per task

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate loading user data on load
            loadUserData();
            loadTasks();
            loadUserTasks();
            loadWithdrawalHistory();
            // Initialize TG Stars payment system (conceptually)
            // In a real scenario, this would involve more complex API calls.
            console.log("TG Stars payment system initialized (conceptually).");

            // Setup ad timer and daily limit check
            checkDailyAdLimit();
        });

        // --- Navigation ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = e.target.id.replace('nav-', '');
                const targetSection = document.getElementById(`${targetId}-section`);

                sections.forEach(section => section.classList.remove('active'));
                navLinks.forEach(nav => nav.classList.remove('active'));

                targetSection.classList.add('active');
                e.target.classList.add('active');
            });
        });

        // --- User Data Management ---
        function loadUserData() {
            profileTelegramIdSpan.textContent = telegramUser.id;
            profileUsernameSpan.textContent = telegramUser.username || 'N/A';

            // Load user-specific data from Firebase
            const userRef = database.ref(`users/${telegramUser.id}`);
            userRef.once('value', (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    currentBalance = userData.balance || 0;
                    profileTasksCompletedSpan.textContent = userData.tasksCompleted || 0;
                    profileTotalImpressionsSpan.textContent = userData.totalImpressions || 0;
                    updateBalanceDisplay();
                } else {
                    // Initialize user data if not exists
                    userRef.set({
                        telegramId: telegramUser.id,
                        username: telegramUser.username,
                        balance: 0,
                        tasksCompleted: 0,
                        totalImpressions: 0,
                        joinedAt: Date.now()
                    });
                }
            });
        }

        function updateBalanceDisplay() {
            profileBalanceSpan.textContent = `${currentBalance.toFixed(5)} TON`;
        }

        // --- Task Management ---
        function loadTasks() {
            const tasksRef = database.ref('tasks');
            tasksRef.on('value', (snapshot) => {
                tasks = []; // Clear previous tasks
                snapshot.forEach((childSnapshot) => {
                    tasks.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderTasks();
            });
        }

        function renderTasks() {
            taskListDiv.innerHTML = ''; // Clear existing tasks
            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.classList.add('task-card');
                taskCard.innerHTML = `
                    <div class="task-details">
                        <h3>${task.title}</h3>
                        <p>${task.description}</p>
                        <p>Impressions: ${task.impressions}</p>
                        <p>Cost: ${task.starCost} TG Stars</p>
                    </div>
                    <div class="task-actions">
                        <button onclick="startTask('${task.id}')" ${userTasks.some(ut => ut.taskId === task.id && ut.status === 'running') ? 'disabled' : ''}>
                            Start
                        </button>
                        <div class="timer" id="timer-${task.id}"></div>
                    </div>
                `;
                taskListDiv.appendChild(taskCard);
            });
        }

        function startTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Check if user already has a running task or enough stars (conceptually)
            // In a real system, you'd interact with TG bot for star balance.

            const userTaskRef = database.ref(`userTasks/${telegramUser.id}/${taskId}`);
            userTaskRef.set({
                taskId: taskId,
                status: 'running',
                startTime: Date.now(),
                taskDetails: { // Store task details to avoid frequent lookups
                    title: task.title,
                    url: task.url,
                    impressions: task.impressions,
                    starCost: task.starCost
                }
            });

            // Visually disable the start button and show timer
            const startButton = taskListDiv.querySelector(`button[onclick="startTask('${taskId}')"]`);
            if (startButton) {
                startButton.disabled = true;
                const timerDiv = document.getElementById(`timer-${taskId}`);
                startTimer(taskId, 10, timerDiv, task.url); // 10 seconds for verification
            }
        }

        function startTimer(taskId, seconds, timerElement, taskUrl) {
            let remainingSeconds = seconds;
            timerElement.textContent = `Verify in ${remainingSeconds}s`;

            const interval = setInterval(() => {
                remainingSeconds--;
                timerElement.textContent = `Verify in ${remainingSeconds}s`;

                if (remainingSeconds <= 0) {
                    clearInterval(interval);
                    timerElement.textContent = ''; // Clear timer text

                    // Open task URL
                    window.open(taskUrl, '_blank');

                    // After 5 seconds of viewing, simulate completion
                    setTimeout(() => {
                        completeTask(taskId);
                    }, 5000); // Simulate 5s viewing time
                }
            }, 1000);
        }

        function completeTask(taskId) {
            const userTaskRef = database.ref(`userTasks/${telegramUser.id}/${taskId}`);
            userTaskRef.update({ status: 'completed', completedAt: Date.now() });

            // Update user's balance and stats
            currentBalance += TASK_EARNING;
            const userStatsRef = database.ref(`users/${telegramUser.id}`);
            userStatsRef.once('value', (snapshot) => {
                const userData = snapshot.val();
                userStatsRef.update({
                    balance: currentBalance,
                    tasksCompleted: (userData.tasksCompleted || 0) + 1,
                    totalImpressions: (userData.totalImpressions || 0) + tasks.find(t => t.id === taskId).impressions
                });
                loadUserData(); // Refresh displayed data
            });

            alert(`Task ${taskId} completed! You earned ${TASK_EARNING} TON.`);
        }

        function loadUserTasks() {
            const userTasksRef = database.ref(`userTasks/${telegramUser.id}`);
            userTasksRef.on('value', (snapshot) => {
                userTasks = [];
                snapshot.forEach((childSnapshot) => {
                    userTasks.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderMyTasks();
            });
        }

        function renderMyTasks() {
            runningTasksList.innerHTML = '';
            completedTasksList.innerHTML = '';
            let totalCompleted = 0;
            let totalImpressions = 0;

            userTasks.forEach(userTask => {
                const task = tasks.find(t => t.id === userTask.taskId);
                if (!task) return; // Skip if task details aren't loaded yet

                const taskItem = document.createElement('li');
                taskItem.classList.add('task-item');
                taskItem.innerHTML = `
                    <span>${task.title}</span>
                    <span class="status">${userTask.status}</span>
                    ${userTask.status === 'completed' ? '<button class="delete-btn" onclick="deleteTask(\'' + userTask.id + '\', \'' + userTask.taskId + '\')">Delete</button>' : ''}
                `;

                if (userTask.status === 'running') {
                    runningTasksList.appendChild(taskItem);
                } else if (userTask.status === 'completed') {
                    completedTasksList.appendChild(taskItem);
                    totalCompleted++;
                    totalImpressions += task.impressions;
                }
            });

            totalUsersCompletedSpan.textContent = totalCompleted;
            totalImpressionsCompletedSpan.textContent = totalImpressions;
        }

        function deleteTask(userTaskId, taskId) {
            // In a real scenario, you might want to confirm this action.
            database.ref(`userTasks/${telegramUser.id}/${userTaskId}`).remove()
                .then(() => {
                    alert('Task deleted.');
                })
                .catch(error => {
                    console.error("Error deleting task:", error);
                    alert('Failed to delete task.');
                });
        }

        // --- Add Task Form Submission ---
        addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const url = document.getElementById('task-url').value;
            const impressions = parseInt(document.getElementById('task-impressions').value, 10);
            const starCost = parseInt(document.getElementById('task-star-cost').value, 10);

            // Basic URL validation
            try {
                new URL(url);
            } catch (_) {
                alert('Please enter a valid URL.');
                return;
            }

            const newTaskRef = database.ref('tasks').push();
            newTaskRef.set({
                title: title,
                description: description,
                url: url,
                impressions: impressions,
                starCost: starCost,
                createdBy: telegramUser.id,
                createdAt: Date.now(),
                status: 'active' // 'active', 'paused', 'deleted'
            }).then(() => {
                alert('Task added successfully!');
                addTaskForm.reset();
            }).catch(error => {
                console.error("Error adding task:", error);
                alert('Failed to add task.');
            });
        });

        // --- Ads Management ---
        watchAdBtn.addEventListener('click', () => {
            if (dailyAdCount >= MAX_DAILY_ADS) {
                dailyAdLimitMessage.style.display = 'block';
                return;
            }

            // Show the libtl ad (this script needs to be loaded properly)
            if (window.show_9789409) {
                adStatusSpan.textContent = 'Loading Ad...';
                watchAdBtn.disabled = true;

                // The libtl script will likely handle ad display.
                // You would need to find a way to know when the ad is viewed.
                // For simulation, we'll just assume it plays and gives earnings.

                // Simulate ad watching and earning
                setTimeout(() => {
                    const earnedAmount = AD_EARNING;
                    currentBalance += earnedAmount;
                    dailyAdCount++;

                    const userStatsRef = database.ref(`users/${telegramUser.id}`);
                    userStatsRef.update({
                        balance: currentBalance
                    });
                    updateBalanceDisplay();

                    adStatusSpan.textContent = `Ad watched! Earned ${earnedAmount} TON.`;
                    checkDailyAdLimit();
                }, 5000); // Simulate a 5 second ad
            } else {
                alert("Ad service not available. Please try again later.");
            }
        });

        function checkDailyAdLimit() {
            const today = new Date().toDateString();
            const lastAdDate = localStorage.getItem('lastAdDate');
            const storedDailyAdCount = parseInt(localStorage.getItem('dailyAdCount') || '0');

            if (lastAdDate === today) {
                dailyAdCount = storedDailyAdCount;
            } else {
                dailyAdCount = 0;
                localStorage.setItem('lastAdDate', today);
                localStorage.setItem('dailyAdCount', '0');
            }

            if (dailyAdCount >= MAX_DAILY_ADS) {
                watchAdBtn.disabled = true;
                dailyAdLimitMessage.style.display = 'block';
            } else {
                watchAdBtn.disabled = false;
                dailyAdLimitMessage.style.display = 'none';
            }
            console.log(`Daily ad count: ${dailyAdCount}/${MAX_DAILY_ADS}`);
        }

        // --- Withdrawal Functionality ---
        requestWithdrawBtn.addEventListener('click', () => {
            const amount = parseFloat(withdrawAmountInput.value);
            const address = withdrawAddressInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount.');
                return;
            }
            if (!address) {
                alert('Please enter your TON wallet address.');
                return;
            }

            // Basic TON address validation (you might want a more robust one)
            if (!address.startsWith('EQ') || address.length < 47) {
                alert('Please enter a valid TON wallet address.');
                return;
            }

            if (amount > currentBalance) {
                alert('Insufficient balance.');
                return;
            }

            // Show confirmation popup
            popupAmountSpan.textContent = amount.toFixed(5);
            popupAddressSpan.textContent = address;
            withdrawConfirmPopup.style.display = 'flex';
        });

        confirmWithdrawBtn.addEventListener('click', () => {
            const amount = parseFloat(popupAmountSpan.textContent);
            const address = popupAddressSpan.textContent;

            // Deduct from balance
            currentBalance -= amount;
            updateBalanceDisplay();

            // Save withdrawal request to Firebase
            const withdrawalRequestRef = database.ref('withdrawalRequests').push();
            withdrawalRequestRef.set({
                userId: telegramUser.id,
                username: telegramUser.username,
                amount: amount,
                address: address,
                status: 'pending', // pending, approved, rejected
                requestedAt: Date.now()
            }).then(() => {
                // Update user's balance in Firebase
                const userStatsRef = database.ref(`users/${telegramUser.id}`);
                userStatsRef.update({ balance: currentBalance });

                alert('Withdrawal request submitted. It will be processed soon.');
                withdrawConfirmPopup.style.display = 'none';
                withdrawAmountInput.value = '';
                withdrawAddressInput.value = '';
                loadWithdrawalHistory(); // Refresh history
            }).catch(error => {
                console.error("Error submitting withdrawal request:", error);
                alert('Failed to submit withdrawal request.');
                // Revert balance deduction if submission failed
                currentBalance += amount;
                updateBalanceDisplay();
                withdrawConfirmPopup.style.display = 'none';
            });
        });

        cancelWithdrawBtn.addEventListener('click', () => {
            withdrawConfirmPopup.style.display = 'none';
        });

        function loadWithdrawalHistory() {
            const historyRef = database.ref('withdrawalRequests').orderByChild('userId').equalTo(telegramUser.id);
            historyRef.on('value', (snapshot) => {
                withdrawalHistoryList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const request = childSnapshot.val();
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        Amount: ${request.amount.toFixed(5)} TON,
                        Address: ${request.address.substring(0, 10)}...,
                        Status: <span style="color: ${request.status === 'pending' ? 'orange' : request.status === 'approved' ? 'green' : 'red'};">${request.status}</span>
                    `;
                    withdrawalHistoryList.appendChild(listItem);
                });
            });
        }

        // --- TG Stars Payment System (Conceptual) ---
        // This is highly simplified and would require actual Telegram Bot API calls
        // via a backend to check user's TG Star balance and deduct them.
        function checkUserStars(userId) {
            // In a real app, you'd call your bot's backend API here.
            console.log(`Checking TG Stars for user ${userId}...`);
            // Mock return value for demonstration
            return 150; // Example: user has 150 TG Stars
        }

        function deductUserStars(userId, amount) {
            // In a real app, you'd call your bot's backend API here.
            console.log(`Deducting ${amount} TG Stars from user ${userId}...`);
            // Mock return value
            return true; // Successfully deducted
        }

        // --- End of Script ---
    </script>

</body>
</html>
