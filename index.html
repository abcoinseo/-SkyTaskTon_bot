<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTaskTon - Earn TON</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Ad SDK - Ensure this script is correctly integrated or replaced if needed -->
    <script src='//libtl.com/sdk.js' data-zone='9789409' data-sdk='show_9789409'></script>

    <!-- TON Connect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <script type="module">
        // --- FIREBASE CONFIG ---
        // !!! REPLACE WITH YOUR ACTUAL FIREBASE CONFIG !!!
        // ... (Your existing Firebase config and initialization) ...
        const firebaseConfig = {
            apiKey: "AIzaSyBSj3t2ClyafHRgpN__cCnbDarhTfse3aA", // Example, replace!
            authDomain: "skytasktonbot.firebaseapp.com",
            projectId: "skytasktonbot",
            storageBucket: "skytasktonbot.firebasestorage.app",
            messagingSenderId: "1078897344814",
            appId: "1:1078897344814:web:166f4341b884d877d97abf"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        window.firebase = { database, ref, push, set, get, onValue, remove, update };
        // --- END FIREBASE CONFIG ---

        // --- TON CONNECT UI INITIALIZATION ---
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://sky-task-ton-bot-compleat.vercel.app/tonconnect-manifest.json', // <-- REPLACE WITH YOUR MANIFEST URL
            buttonRootId: 'ton-connect'
        });

        // Configure wallet connection options (optional but good practice)
        tonConnectUI.uiOptions = {
            actionsConfiguration: {
                twaReturnUrl: 'https://t.me/SkyTaskTonBot?startattach=ton_connect' // URL to return to after connection
            }
        };

        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let userTasks = {}; // Tasks created by the current user
        let allTasks = {}; // All available tasks from Firebase
        let userBalance = 0;
        let userStats = { tasksCreated: 0, tasksCompleted: 0, totalEarnings: 0, adsWatched: 0 };
        let adsWatchedToday = 0;
        let isProcessingPayment = false; // Prevent multiple payment requests
        let currentTab = 'home'; // Track the current active tab
        let taskVerificationInterval = null; // To clear interval when modal closes
        let adCountdownInterval = null; // To clear interval when ad completes or modal closes

        // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL TELEGRAM BOT USERNAME !!!
        const BOT_USERNAME = 'SkyTaskTonBot'; // <-- CHANGE THIS TO YOUR BOT'S USERNAME

        // --- CONSTANTS ---
        const TASK_STARS_RATE_PER_500_IMPRESSIONS = 100; // Stars needed for every 500 impressions
        const TASK_TON_REWARD_PER_COMPLETION = 0.00005; // TON reward for completing a task
        const AD_TON_REWARD = 0.000001; // TON reward per watched ad
        const MAX_DAILY_ADS = 10;
        const AD_COUNTDOWN_SECONDS = 5;
        const TASK_VERIFICATION_SECONDS = 10;
        const SPECIAL_USER_ID_FOR_FREE_TASKS = 8101021767; // User ID for free task creation

        // --- INITIALIZATION ---
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        window.Telegram.WebApp.enableClosingConfirmation();

        document.addEventListener('DOMContentLoaded', function() {
            initializeUser();
            loadUserData();
            updateTaskCostInputHandler();
            initializeDailyAdsResetTimer();
            setupTabButtons();
            updateMainButton('home');
        });

        // --- USER MANAGEMENT ---
        function initializeUser() {
            if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                currentUser = window.Telegram.WebApp.initDataUnsafe.user;
                const displayName = (currentUser.first_name || '') + (currentUser.last_name ? ' ' + currentUser.last_name : '');
                document.getElementById('userName').textContent = displayName.trim() || 'User';
                document.getElementById('userId').textContent = 'ID: ' + currentUser.id;
                const avatarElement = document.querySelector('.profile-avatar');
                if (avatarElement) {
                    avatarElement.textContent = displayName.charAt(0).toUpperCase();
                }

                // Display TON Connect button if user is logged in
                if (!tonConnectUI.connected) {
                    document.getElementById('ton-connect').style.display = 'block';
                } else {
                    document.getElementById('ton-connect').style.display = 'none'; // Hide if already connected
                    document.getElementById('profileBalance').textContent = 'Loading...'; // Indicate balance loading
                    loadUserData(); // Load data immediately after connection
                }

            } else {
                // Fallback for testing outside Telegram environment
                currentUser = {
                    id: Date.now(),
                    first_name: 'TestUser',
                    username: 'testbotuser' + Math.floor(Math.random() * 1000)
                };
                document.getElementById('userName').textContent = 'Test User';
                document.getElementById('userId').textContent = 'ID: ' + currentUser.id;
                showNotification('Running in test mode. Some features might be simulated.', 'info');
                document.getElementById('ton-connect').style.display = 'block'; // Show connect button in test mode
            }
        }

        // --- TON CONNECTION HANDLING ---
        // Display the TON Connect button
        tonConnectUI.connected.then(async (connected) => {
            if (connected) {
                console.log("Already connected to TON wallet.");
                document.getElementById('ton-connect').style.display = 'none';
                loadUserData(); // Load user data if already connected
            } else {
                console.log("Not connected to TON wallet. Displaying connect button.");
                document.getElementById('ton-connect').style.display = 'block';
                // Render the button (this is automatically handled by the UI library if buttonRootId is set)
            }
        });

        // Handle wallet connection status changes
        tonConnectUI.onStatusChange(async (wallet) => {
            if (wallet) {
                console.log("TON wallet connected:", wallet.account.address);
                document.getElementById('ton-connect').style.display = 'none';
                showNotification('TON Wallet connected!', 'success');
                loadUserData(); // Load user data after connection
            } else {
                console.log("TON wallet disconnected.");
                showNotification('TON Wallet disconnected.', 'info');
                // Reset UI or show prompt to connect
                userBalance = 0;
                userStats = { tasksCreated: 0, tasksCompleted: 0, totalEarnings: 0, adsWatched: 0 };
                updateUI();
                document.getElementById('ton-connect').style.display = 'block'; // Show connect button again
            }
        });

        async function connectWallet() {
            try {
                await tonConnectUI.connect();
            } catch (error) {
                console.error("Error connecting wallet:", error);
                showNotification("Failed to connect to TON wallet. Please ensure you have a compatible wallet installed and try again.", "error");
            }
        }

        // --- DATA LOADING AND UI UPDATING ---
        // ... (Your existing loadUserData, updateUI, displayAllTasks, displayMyTasks, createTaskCard functions) ...
        // Ensure loadUserData is called after user and wallet are initialized/connected.

        function loadUserData() {
            if (!currentUser) {
                console.error("No current user found. Cannot load user data.");
                return;
            }

            // Only proceed if connected to TON wallet or in test mode
            if (!tonConnectUI.connected && !currentUser.username?.startsWith('testbotuser')) {
                 console.log("Wallet not connected, skipping user data load.");
                 return;
            }

            document.getElementById('allTasksList').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('myTasksList').innerHTML = '<div class="loading-spinner"></div>';

            const userRef = firebase.ref(firebase.database, `users/${currentUser.id}`);
            firebase.onValue(userRef, (snapshot) => {
                const userData = snapshot.val() || {};
                userBalance = userData.balance || 0;
                userStats = userData.stats || { tasksCreated: 0, tasksCompleted: 0, totalEarnings: 0, adsWatched: 0 };
                adsWatchedToday = userData.adsWatchedToday || 0;
                updateUI();
            }, (error) => {
                console.error("Error fetching user data:", error);
                showNotification("Failed to load user data.", "error");
            });

            const tasksRef = firebase.ref(firebase.database, 'tasks');
            firebase.onValue(tasksRef, (snapshot) => {
                allTasks = snapshot.val() || {};
                displayAllTasks();
            }, (error) => {
                console.error("Error fetching all tasks:", error);
                showNotification("Failed to load tasks.", "error");
            });

            const userTasksRef = firebase.ref(firebase.database, `userTasks/${currentUser.id}`);
            firebase.onValue(userTasksRef, (snapshot) => {
                userTasks = snapshot.val() || {};
                displayMyTasks();
            }, (error) => {
                console.error("Error fetching user tasks:", error);
                showNotification("Failed to load your tasks.", "error");
            });
        }

        function updateUI() {
            document.getElementById('userBalance').textContent = userBalance.toFixed(5);
            document.getElementById('profileBalance').textContent = userBalance.toFixed(5);
            document.getElementById('profileTasks').textContent = userStats.tasksCreated;
            document.getElementById('profileEarnings').textContent = userStats.totalEarnings.toFixed(5);
            document.getElementById('profileAdsWatched').textContent = userStats.adsWatched;

            const activeTasksCount = Object.values(allTasks).filter(task => task.status === 'active').length;
            document.getElementById('totalTasks').textContent = activeTasksCount;
            document.getElementById('completedTasks').textContent = userStats.tasksCompleted;
            document.getElementById('totalEarnings').textContent = userStats.totalEarnings.toFixed(5);

            document.getElementById('adsRemaining').textContent = Math.max(0, MAX_DAILY_ADS - adsWatchedToday);

            const watchAdBtn = document.getElementById('watchAdBtn');
            if (adsWatchedToday >= MAX_DAILY_ADS) {
                watchAdBtn.disabled = true;
                watchAdBtn.innerHTML = '<span class="material-icons">block</span>Daily Limit Reached';
                watchAdBtn.style.opacity = '0.6';
            } else {
                watchAdBtn.disabled = false;
                watchAdBtn.innerHTML = '<span class="material-icons">play_arrow</span>Watch Ad Now';
                watchAdBtn.style.opacity = '1';
            }
        }


        // --- TASK MANAGEMENT ---
        function updateTaskCostInputHandler() {
            const impressionsInput = document.getElementById('totalImpressions');
            const costSpan = document.getElementById('taskCost');
            const progressBar = document.getElementById('costProgress');

            impressionsInput.addEventListener('input', function() {
                const impressions = parseInt(this.value) || 0;
                const cost = Math.ceil((impressions / 500) * TASK_STARS_RATE_PER_500_IMPRESSIONS);
                costSpan.textContent = cost;

                const progress = Math.min((impressions / 4000) * 100, 100); // Cap progress at 4000 impressions for visual
                progressBar.style.width = progress + '%';
            });
        }

        // Add Task Form Submission
        document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isProcessingPayment) {
                showNotification('Payment already in progress...', 'info');
                return;
            }

            // Check if connected to TON wallet
            if (!tonConnectUI.connected && !currentUser.username?.startsWith('testbotuser')) {
                showNotification('Please connect your TON wallet to create a task.', 'warning');
                connectWallet(); // Prompt to connect wallet
                return;
            }

            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const url = document.getElementById('taskUrl').value.trim();
            const impressionsInput = document.getElementById('totalImpressions');
            const impressions = parseInt(impressionsInput.value);

            // Validation
            if (!title || !description || !url) {
                showNotification('Please fill in all required fields.', 'error');
                return;
            }
            if (impressions < 500) { // Minimum impressions check
                showNotification('Minimum 500 impressions required!', 'error');
                return;
            }
            if (!url.startsWith('http')) {
                 showNotification('Please enter a valid URL.', 'error');
                 return;
            }

            const costInStars = Math.ceil((impressions / 500) * TASK_STARS_RATE_PER_500_IMPRESSIONS);

            // --- Handle Free Task Creation Logic ---
            const isFreeTask = currentUser && currentUser.id === SPECIAL_USER_ID_FOR_FREE_TASKS;

            if (isFreeTask) {
                showNotification('Creating task for special user (free).', 'info');
                try {
                    await createTask(title, description, url, 0, impressions); // Pass 0 for cost, and impressions
                    showNotification('Task created successfully! 🎉', 'success');
                    document.getElementById('addTaskForm').reset();
                    document.getElementById('taskCost').textContent = '0';
                    document.getElementById('costProgress').style.width = '0%';
                    switchTab('home');
                } catch (error) {
                    console.error("Error creating free task:", error);
                    showNotification(`Error creating task: ${error.message}`, 'error');
                }
                return; // Exit after creating the free task
            }
            // --- End Free Task Creation Logic ---

            // --- TON Payment Initiation ---
            const transactionAmount = 0.5; // This is the example from your snippet.
                                            // You need to convert Stars to TON.
                                            // This usually involves a backend service or a known rate.
                                            // For simplicity here, let's assume a fixed rate or use the Stars directly if your bot handles it.
                                            // **IMPORTANT:** Telegram Payments via bot use TONCOIN directly, not Stars.
                                            // You'll need to coordinate with your bot backend to handle the conversion or payment flow.

            // The example provided used `amount: "like ammount per 500 imprason 0.5 ton "`
            // This implies your bot backend might handle the conversion or payment initiation.
            // For direct web app payments, you'd typically use a mechanism that your bot provides.

            // **If your BOT handles the invoice generation:**
            // You would likely open an invoice provided by your bot.
            // The `openInvoice` method is for Telegram's built-in payment system.

            const invoiceAmountInNanoTon = BigInt(Math.round(transactionAmount * 1_000_000_000)); // Example: 0.5 TON in nanitons
            const destinationAddress = "EQABa48hjKzg09hN_HjxOic7r8T1PleIy1dRd8NvZ3922MP0"; // Example: Replace with your recipient address

            const transactionPayload = {
                validUntil: Math.floor(Date.now() / 1000) + 60, // 60 seconds
                messages: [
                    {
                        address: destinationAddress,
                        amount: invoiceAmountInNanoTon.toString(), // Amount in nanitons
                    }
                ]
            };

            console.log("Attempting to send TON transaction for task creation:", transactionPayload);

            try {
                isProcessingPayment = true;
                document.getElementById('paymentModal').style.display = 'block';
                document.getElementById('paymentModal').querySelector('h2').textContent = 'Confirm TON Payment';
                document.getElementById('paymentModal').querySelector('p').textContent = `Please confirm the transaction in your TON wallet to pay ${transactionAmount} TON for the task.`;

                const result = await tonConnectUI.sendTransaction(transactionPayload);
                console.log("TON Transaction Result:", result);

                if (result && result.boc) {
                    // Transaction was successfully sent to the network
                    // Now, you need to confirm the payment with your bot backend.
                    // Your bot should listen for transaction confirmations or have a way to verify payment for this task.

                    // For now, let's assume success and create the task.
                    // In a real scenario, you'd wait for confirmation from your bot's backend.
                    await createTask(title, description, url, costInStars, impressions); // Cost in stars is for display/tracking
                    showNotification('Task created successfully! 🎉', 'success');
                    document.getElementById('addTaskForm').reset();
                    document.getElementById('taskCost').textContent = '0';
                    document.getElementById('costProgress').style.width = '0%';
                    switchTab('home');
                } else {
                    showNotification('TON transaction failed or was cancelled. Task not created.', 'error');
                }
            } catch (error) {
                console.error('Error sending TON transaction:', error);
                if (error.code === 'USER_REJECT') {
                    showNotification('TON transaction rejected by user. Task not created.', 'warning');
                } else {
                    showNotification(`Error sending TON transaction: ${error.message}. Task not created.`, 'error');
                }
            } finally {
                isProcessingPayment = false;
                closeModal('paymentModal');
            }
        });

        async function createTask(title, description, url, costInStars, totalImpressions) {
            const taskId = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const taskData = {
                id: taskId,
                title,
                description,
                url,
                totalImpressions: totalImpressions || parseInt(document.getElementById('totalImpressions').value),
                currentImpressions: 0,
                costInStars: costInStars, // Store the cost in stars for reference
                rewardPerCompletion: TASK_TON_REWARD_PER_COMPLETION,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                status: 'active',
                completedBy: []
            };

            try {
                // Save the task details to Firebase
                await firebase.set(firebase.ref(firebase.database, `tasks/${taskId}`), taskData);
                await firebase.set(firebase.ref(firebase.database, `userTasks/${currentUser.id}/${taskId}`), taskData);

                // Update user stats for tasks created
                const updatedStats = {
                    ...userStats,
                    tasksCreated: userStats.tasksCreated + 1
                };
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/stats`), updatedStats);

                console.log(`Task ${taskId} created successfully.`);

            } catch (error) {
                console.error("Error saving task to Firebase:", error);
                // You might want to rollback or notify the user about the payment if task creation fails
                throw error;
            }
        }


        // --- WITHDRAWAL SYSTEM ---
        // ... (Your existing withdrawal logic) ...

        // --- ADS FUNCTIONALITY ---
        // ... (Your existing ads logic) ...

        // --- MODAL AND NOTIFICATION HELPERS ---
        // ... (Your existing closeModal, showNotification functions) ...
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                if (modalId === 'verifyModal') {
                    if (taskVerificationInterval) {
                        clearInterval(taskVerificationInterval);
                        taskVerificationInterval = null;
                    }
                }
                // Reset payment modal state if closed
                if (modalId === 'paymentModal') {
                    isProcessingPayment = false;
                }
            }
        }


        // --- TELEGRAM WEB APP EVENTS ---
        window.Telegram.WebApp.onEvent('mainButtonClicked', function() {
            const activeTabId = currentTab;
            console.log('Main button clicked in tab:', activeTabId);
            // You can add actions here based on the current tab if needed.
        });

        window.Telegram.WebApp.onEvent('backButtonClicked', function() {
            if (currentTab !== 'home') {
                switchTab('home');
                updateMainButton('home');
            } else {
                window.Telegram.WebApp.close();
            }
        });

    </script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (Your existing CSS styles) ... */

        /* TON Connect Button Styling */
        #ton-connect {
            margin: 15px auto;
            display: none; /* Initially hidden, shown via JS */
        }
        .ton-connect-button { /* Default styles applied by TON Connect UI */
            background: var(--primary-gradient) !important;
            color: white !important;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
            border-radius: 30px !important;
            padding: 14px 28px !important;
            font-weight: 600 !important;
            font-size: 1em !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            text-decoration: none !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        .ton-connect-button:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5) !important;
        }
        .ton-connect-button::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .ton-connect-button:hover::before {
            left: 100%;
        }

        /* Specific Tab Styles */
        #home { padding-top: 15px; }
        #home h2 { margin-top: 30px; margin-bottom: 20px; }
        #ads .ad-container > .material-icons { font-size: 4em; color: var(--primary-color); margin-bottom: 20px; }
        #ads p strong { color: var(--primary-color); }
        #ads h3 { margin-bottom: 15px; color: var(--text-color); }
        #adDisplay { min-height: 350px; }
        #adContent { /* Placeholder styling */ }
        #paymentModal .modal-content { background: var(--primary-gradient); color: white; }
        #paymentModal .modal-content h2, #paymentModal .modal-content p { color: white !important; }
        #paymentModal .loading-spinner { border-top-color: white; border-color: rgba(255,255,255,0.5); }
        #verifyModal .modal-content .material-icons { color: var(--primary-color); }

        /* Developer Info Footer */
        .developer-info {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
            color: var(--light-text-color);
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        .developer-info a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
        }
        .developer-info a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 SkyTaskTon</h1>
            <div class="balance">
                💎 Balance: <span id="userBalance">0.00000</span> TON
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">
                <span class="material-icons">home</span>
                <span>Home</span>
            </button>
            <button class="nav-tab" onclick="switchTab('tasks')">
                <span class="material-icons">assignment</span>
                <span>My Tasks</span>
            </button>
            <button class="nav-tab" onclick="switchTab('add-task')">
                <span class="material-icons">add_circle</span>
                <span>Add Task</span>
            </button>
            <button class="nav-tab" onclick="switchTab('ads')">
                <span class="material-icons">ads_click</span>
                <span>Ads</span>
            </button>
            <button class="nav-tab" onclick="switchTab('profile')">
                <span class="material-icons">person</span>
                <span>Profile</span>
            </button>
        </div>

        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarnings">0.00000</div>
                    <div class="stat-label">Total Earned</div>
                </div>
            </div>
            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 1.8em; color: var(--text-color);">🚀 Available Tasks</h2>
            <div id="allTasksList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- My Tasks Tab -->
        <div id="tasks" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">📝 My Tasks</h2>
            <div id="myTasksList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Add Task Tab -->
        <div id="add-task" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">➕ Create New Task</h2>

            <!-- TON Connect Button Container -->
            <div id="ton-connect" style="text-align: center; margin-bottom: 20px;">
                <!-- TON Connect UI will render the button here -->
            </div>

            <form id="addTaskForm">
                <div class="form-group">
                    <label for="taskTitle">Task Title *</label>
                    <input type="text" id="taskTitle" class="form-control" placeholder="Enter an engaging task title" required>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Task Description *</label>
                    <textarea id="taskDescription" class="form-control" rows="4" placeholder="Describe what users need to do" required></textarea>
                </div>
                <div class="form-group">
                    <label for="taskUrl">Task URL *</label>
                    <input type="url" id="taskUrl" class="form-control" placeholder="https://example.com" required>
                </div>
                <div class="form-group">
                    <label for="totalImpressions">Total Impressions *</label>
                    <input type="number" id="totalImpressions" class="form-control" min="500" step="100" placeholder="Minimum 500 impressions" required>
                </div>
                <div class="cost-display">
                    💰 Estimated Cost: <span id="taskCost">0</span> Stars
                    <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.9;">
                        Rate: 500 impressions = 100 Stars (approx. 0.5 TON)
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="costProgress"></div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    <span class="material-icons">payment</span>
                    Create Task & Pay
                </button>
            </form>
        </div>

        <!-- Ads Tab -->
        <div id="ads" class="tab-content">
            <!-- ... (Your existing Ads Tab content) ... -->
             <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">📺 Watch Ads & Earn</h2>
        <div class="ad-container">
            <div class="material-icons" style="font-size: 4em; color: var(--primary-color); margin-bottom: 20px;">play_circle_filled</div>
            <h3 style="margin-bottom: 15px;">Daily Ads Available</h3>
            <div class="ads-remaining">
                <span id="adsRemaining">10</span> / 10 Ads Remaining
            </div>
            <p style="margin: 20px 0; color: var(--light-text-color); font-size: 1.1em;">
                Earn <strong>0.000001</strong> TON per ad watched!
            </p>
            <button id="watchAdBtn" class="btn btn-success" style="font-size: 1.1em;">
                <span class="material-icons">play_arrow</span>
                Watch Ad Now
            </button>
            <div style="margin-top: 20px; font-size: 0.9em; color: #888;">
                Ads reset daily at midnight
            </div>
        </div>
        <div id="adDisplay" style="display: none;" class="ad-container">
            <h3>Please wait while the ad loads...</h3>
            <div id="adContent" style="min-height: 200px; margin: 20px 0;"></div>
            <div class="countdown" id="adCountdown">5</div>
            <div class="progress-bar">
                <div class="progress-fill" id="adProgress"></div>
            </div>
        </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="profile-card">
                <div class="profile-avatar">
                    <span class="material-icons">person</span>
                </div>
                <h2 id="userName" style="margin-bottom: 8px; font-size: 1.8em;">Loading...</h2>
                <p id="userId" style="color: var(--light-text-color); margin-bottom: 25px;">ID: Loading...</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="profileBalance">0.00000</div>
                        <div class="stat-label">TON Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileTasks">0</div>
                        <div class="stat-label">Tasks Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileEarnings">0.00000</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileAdsWatched">0</div>
                        <div class="stat-label">Ads Watched</div>
                    </div>
                </div>
                <button id="withdrawBtn" class="btn btn-warning" style="margin-top: 20px; font-size: 1.1em;">
                    <span class="material-icons">account_balance_wallet</span>
                    Withdraw TON
                </button>
            </div>
            <div class="developer-info">
                Bot Developer: <a href="https://t.me/abstudioseo" target="_blank">@abstudioseo</a>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('withdrawModal')">&times;</span>
            <h2 style="margin-bottom: 25px; color: var(--text-color);">💰 Withdraw TON</h2>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawAmount">Amount (TON) *</label>
                    <input type="number" id="withdrawAmount" class="form-control" step="0.00001" min="0.001" placeholder="Minimum 0.001 TON" required>
                </div>
                <div class="form-group">
                    <label for="tonAddress">TON Wallet Address *</label>
                    <input type="text" id="tonAddress" class="form-control" placeholder="Enter your TON wallet address (starts with UQ)" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">
                    <span class="material-icons">send</span>
                    Submit Withdrawal Request
                </button>
            </form>
        </div>
    </div>

    <!-- Task Verification Modal -->
    <div id="verifyModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close" onclick="closeModal('verifyModal')">&times;</span>
            <div class="material-icons" style="font-size: 4em; color: var(--primary-color); margin-bottom: 20px;">hourglass_empty</div>
            <h2 style="margin-bottom: 20px; color: var(--text-color);">⏳ Task Verification</h2>
            <p style="margin-bottom: 25px; color: var(--light-text-color);">Please wait while we verify your task completion...</p>
            <div class="countdown" id="verifyCountdown">10</div>
            <div class="progress-bar">
                <div class="progress-fill" id="verifyProgress"></div>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal (Generic for TON Payment) -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="text-align: center; background: var(--primary-gradient); color: white;">
            <div class="material-icons pulse" style="font-size: 4em; color: white; margin-bottom: 20px;">payment</div>
            <h2 style="margin-bottom: 20px;">Confirm TON Payment</h2>
            <p style="margin-bottom: 25px; opacity: 0.9;">Please confirm the transaction in your TON wallet...</p>
            <div class="loading-spinner" style="border-top-color: white; border-color: rgba(255,255,255,0.5);"></div>
        </div>
    </div>

    <script>
        // --- Global Functions for Navigation and UI ---
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            currentTab = tabName;
            updateMainButton(tabName);
        }

        function updateMainButton(tabName) {
            let buttonText = '';
            switch (tabName) {
                case 'home': buttonText = 'View Tasks'; break;
                case 'tasks': buttonText = 'My Tasks'; break;
                case 'add-task': buttonText = 'Create Task'; break;
                case 'ads': buttonText = 'Watch Ads'; break;
                case 'profile': buttonText = 'My Profile'; break;
                default: buttonText = 'Back';
            }
            window.Telegram.WebApp.MainButton.setText(buttonText);
            window.Telegram.WebApp.MainButton.show();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                if (modalId === 'verifyModal') {
                    if (taskVerificationInterval) {
                        clearInterval(taskVerificationInterval);
                        taskVerificationInterval = null;
                    }
                }
                // Reset payment modal state if closed
                if (modalId === 'paymentModal') {
                    isProcessingPayment = false;
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s reverse forwards';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // --- TON Connect Button Click Handler (if you want explicit button) ---
        // You can add an onclick to the #ton-connect div if needed, but TON Connect UI handles rendering.
        // document.getElementById('ton-connect').addEventListener('click', connectWallet);


        // --- DAILY RESET LOGIC ---
        function initializeDailyAdsResetTimer() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setHours(0, 0, 0, 0);
            tomorrow.setDate(now.getDate() + 1);

            const msUntilMidnight = tomorrow.getTime() - now.getTime();

            setTimeout(async () => {
                await resetDailyAds();
                setInterval(resetDailyAds, 24 * 60 * 60 * 1000);
            }, msUntilMidnight);
        }

        async function resetDailyAds() {
            if (currentUser) {
                try {
                    await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/adsWatchedToday`), 0);
                    showNotification('Daily ads reset! You can watch 10 more ads today.', 'info');
                    loadUserData();
                } catch (error) {
                    console.error("Error resetting daily ads:", error);
                    showNotification("Failed to reset daily ads count.", "error");
                }
            }
        }

        // Call the function to set up the listener for the TON Connect button if it's directly managed
        // If TON Connect UI renders it, this might not be needed unless you want custom actions on click.
        // The TON Connect UI automatically renders a button when `buttonRootId` is provided.
        // document.getElementById('ton-connect').addEventListener('click', connectWallet);

    </script>
</body>
</html>
