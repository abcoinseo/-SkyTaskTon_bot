<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTaskTon</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js"></script>
    <script src="//libtl.com/sdk.js" data-zone="9789409" data-sdk="show_9789409"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
        }
        #app {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
            padding-bottom: 60px;
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        .page {
            display: none;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .page.active {
            display: block;
            opacity: 1;
        }
        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .tabs button {
            padding: 10px 20px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .tabs button:hover {
            background: #0056b3;
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .task {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .task:hover {
            transform: scale(1.02);
        }
        form {
            display: flex;
            flex-direction: column;
        }
        input, textarea {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #218838;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-around;
            background: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            padding: 10px 0;
        }
        .bottom-nav button {
            background: none;
            border: none;
            font-size: 24px;
            color: #007bff;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            animation: scaleIn 0.3s;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); }
            to { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="home" class="page active">
            <h1>Home</h1>
            <div class="tabs">
                <button id="all-tasks-btn">All Tasks</button>
                <button id="completed-tasks-btn">Completed Tasks</button>
            </div>
            <div id="all-tasks" class="tab active"></div>
            <div id="completed-tasks" class="tab"></div>
        </div>
        <div id="add-task-page" class="page">
            <h1>Tasks</h1>
            <div class="tabs">
                <button id="add-form-btn">Add Task</button>
                <button id="my-tasks-btn">My Tasks</button>
            </div>
            <div id="add-form" class="tab active">
                <form id="task-form">
                    <input id="title" placeholder="Task Title" required>
                    <textarea id="desc" placeholder="Task Description" required></textarea>
                    <input id="url" type="url" placeholder="Task URL" required>
                    <input id="impressions" type="number" min="500" placeholder="Total Impressions (min 500)" required>
                    <button type="submit">Add Task</button>
                </form>
            </div>
            <div id="my-tasks" class="tab"></div>
        </div>
        <div id="ads" class="page">
            <h1>Ads</h1>
            <p>Daily Ads Left: <span id="ads-left">10</span></p>
            <button id="watch-ad-btn">Watch Ad</button>
        </div>
        <div id="profile" class="page">
            <h1>Profile</h1>
            <p>Username: <span id="username"></span></p>
            <p>Balance: <span id="balance">0.000000</span> TON</p>
            <button id="withdraw-btn">Withdraw</button>
            <h2>Withdrawal History</h2>
            <div id="history"></div>
        </div>
        <div id="withdraw-modal" class="modal">
            <div class="modal-content">
                <input id="withdraw-amount" type="number" step="0.000001" placeholder="Amount (TON)" required>
                <input id="withdraw-address" placeholder="TON Address" required>
                <button id="submit-withdraw">Submit</button>
                <button id="cancel-withdraw">Cancel</button>
            </div>
        </div>
        <nav class="bottom-nav">
            <button onclick="showPage('home')"><i class="material-icons">home</i></button>
            <button onclick="showPage('add-task-page')"><i class="material-icons">add</i></button>
            <button onclick="showPage('ads')"><i class="material-icons">ondemand_video</i></button>
            <button onclick="showPage('profile')"><i class="material-icons">person</i></button>
        </nav>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        const user = tg.initDataUnsafe.user || { id: 'test', username: 'test' };
        const userId = user.id.toString();
        const username = user.username || 'Anonymous';
        document.getElementById('username').innerText = username;

        const firebaseConfig = {
            apiKey: "AIzaSyBSj3t2ClyafHRgpN__cCnbDarhTfse3aA",
            authDomain: "skytasktonbot.firebaseapp.com",
            projectId: "skytasktonbot",
            storageBucket: "skytasktonbot.firebasestorage.app",
            messagingSenderId: "1078897344814",
            appId: "1:1078897344814:web:166f4341b884d877d97abf"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);
        const botToken = '8418101664:AAGUUWpQVhrueHoP97W5laKOOlJ1LNKGQm8';

        let completedTasks = {};
        db.ref(`userCompletions/${userId}`).on('value', snap => {
            completedTasks = snap.val() || {};
            loadAllTasks();
            loadCompletedTasks();
        });

        db.ref(`users/${userId}/balance`).on('value', snap => {
            document.getElementById('balance').innerText = (snap.val() || 0).toFixed(6);
        });

        const adsRef = db.ref(`users/${userId}/ads`);
        adsRef.on('value', snap => {
            let data = snap.val() || { count: 0, date: '' };
            const today = new Date().toISOString().slice(0, 10);
            if (data.date !== today) {
                data = { count: 0, date: today };
                adsRef.set(data);
            }
            document.getElementById('ads-left').innerText = 10 - data.count;
            document.getElementById('watch-ad-btn').disabled = data.count >= 10;
        });

        db.ref('withdraws').orderByChild('userId').equalTo(userId).on('value', snap => {
            let html = '';
            const reqs = snap.val() || {};
            for (let id in reqs) {
                const req = reqs[id];
                html += `<p>Amount: ${req.amount.toFixed(6)} TON to ${req.address} - Status: ${req.status}</p>`;
            }
            document.getElementById('history').innerHTML = html;
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if (pageId === 'home') {
                loadAllTasks();
                loadCompletedTasks();
            } else if (pageId === 'add-task-page') {
                loadMyTasks();
            } else if (pageId === 'ads') {
                // ads loaded via on
            } else if (pageId === 'profile') {
                // balance and history via on
            }
        }

        document.getElementById('all-tasks-btn').onclick = () => {
            document.getElementById('all-tasks').classList.add('active');
            document.getElementById('completed-tasks').classList.remove('active');
        };
        document.getElementById('completed-tasks-btn').onclick = () => {
            document.getElementById('all-tasks').classList.remove('active');
            document.getElementById('completed-tasks').classList.add('active');
        };

        document.getElementById('add-form-btn').onclick = () => {
            document.getElementById('add-form').classList.add('active');
            document.getElementById('my-tasks').classList.remove('active');
        };
        document.getElementById('my-tasks-btn').onclick = () => {
            document.getElementById('add-form').classList.remove('active');
            document.getElementById('my-tasks').classList.add('active');
        };

        function loadAllTasks() {
            db.ref('tasks').once('value').then(snap => {
                const tasks = snap.val() || {};
                let html = '';
                for (let id in tasks) {
                    if (!(id in completedTasks)) {
                        const task = tasks[id];
                        html += `<div class="task">
                            <h3>${task.title}</h3>
                            <p>${task.desc}</p>
                            <button onclick="startTask('${id}', '${task.url}')">Start</button>
                        </div>`;
                    }
                }
                document.getElementById('all-tasks').innerHTML = html;
            });
        }

        function loadCompletedTasks() {
            db.ref('tasks').once('value').then(snap => {
                const tasks = snap.val() || {};
                let html = '';
                for (let id in completedTasks) {
                    const task = tasks[id];
                    if (task) {
                        html += `<div class="task">
                            <h3>${task.title}</h3>
                            <p>${task.desc}</p>
                            <p>Completed</p>
                        </div>`;
                    }
                }
                document.getElementById('completed-tasks').innerHTML = html;
            });
        }

        function startTask(id, url) {
            window.open(url, '_blank');
            setTimeout(() => {
                db.ref(`completions/${id}/${userId}`).once('value').then(s => {
                    if (!s.val()) {
                        db.ref(`tasks/${id}`).transaction(t => {
                            if (t && (t.completed || 0) < t.totalImpressions) {
                                t.completed = (t.completed || 0) + 1;
                                return t;
                            }
                            return null; // abort if not
                        }).then(r => {
                            if (r.committed && r.snapshot.val() !== null) {
                                db.ref(`completions/${id}/${userId}`).set(true);
                                db.ref(`userCompletions/${userId}/${id}`).set(true);
                                db.ref(`users/${userId}/balance`).transaction(b => (b || 0) + 0.00005);
                            }
                        });
                    }
                });
            }, 10000);
        }

        function loadMyTasks() {
            db.ref('tasks').once('value').then(snap => {
                const tasks = snap.val() || {};
                let html = '';
                for (let id in tasks) {
                    const task = tasks[id];
                    if (task.owner === userId) {
                        html += `<div class="task">
                            <h3>${task.title}</h3>
                            <p>Completed: ${task.completed || 0} / ${task.totalImpressions}</p>
                            <p>Total Users Completed: ${task.completed || 0}</p>
                            <button onclick="deleteTask('${id}')">Delete</button>
                        </div>`;
                    }
                }
                document.getElementById('my-tasks').innerHTML = html;
            });
        }

        function deleteTask(id) {
            db.ref(`tasks/${id}`).remove();
            loadMyTasks();
        }

        document.getElementById('task-form').onsubmit = e => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const url = document.getElementById('url').value;
            const impressions = parseInt(document.getElementById('impressions').value);
            if (impressions < 500) return alert('Minimum 500 impressions');
            const stars = Math.ceil((impressions / 500) * 100);
            const taskData = { title, desc, url, impressions };
            if (username === 'Abstudioseo') {
                addTaskToDb(taskData);
            } else {
                payStars(stars, taskData);
            }
        };

        function payStars(amount, taskData) {
            fetch(`https://api.telegram.org/bot${botToken}/createInvoiceLink`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: 'Task Advertisement',
                    description: `Pay for ${taskData.impressions} impressions`,
                    payload: `${userId}:${Date.now()}`,
                    currency: 'XTR',
                    prices: [{ label: 'Impressions', amount }]
                })
            }).then(res => res.json()).then(data => {
                if (data.ok) {
                    tg.openInvoice(data.result, status => {
                        if (status === 'paid') {
                            addTaskToDb(taskData);
                        }
                    });
                } else {
                    alert('Payment failed to initialize');
                }
            }).catch(err => {
                console.error(err);
                alert('Error creating invoice');
            });
        }

        function addTaskToDb(taskData) {
            const newTask = {
                title: taskData.title,
                desc: taskData.desc,
                url: taskData.url,
                totalImpressions: taskData.impressions,
                completed: 0,
                owner: userId
            };
            db.ref('tasks').push(newTask);
            document.getElementById('task-form').reset();
            loadMyTasks();
        }

        document.getElementById('watch-ad-btn').onclick = () => {
            adsRef.once('value').then(snap => {
                const data = snap.val();
                if (data.count < 10) {
                    show_9789409().then(() => {
                        db.ref(`users/${userId}/balance`).transaction(b => (b || 0) + 0.000001);
                        adsRef.transaction(d => {
                            d.count = (d.count || 0) + 1;
                            return d;
                        });
                    }).catch(err => console.error('Ad failed', err));
                } else {
                    alert('Daily limit reached');
                }
            });
        };

        document.getElementById('withdraw-btn').onclick = () => {
            document.getElementById('withdraw-modal').classList.add('active');
        };

        document.getElementById('cancel-withdraw').onclick = () => {
            document.getElementById('withdraw-modal').classList.remove('active');
        };

        document.getElementById('submit-withdraw').onclick = () => {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const address = document.getElementById('withdraw-address').value;
            if (!amount || !address) return alert('Please fill all fields');
            db.ref(`users/${userId}/balance`).once('value').then(snap => {
                const bal = snap.val() || 0;
                if (amount > bal) return alert('Insufficient balance');
                db.ref('withdraws').push({
                    userId,
                    username,
                    amount,
                    address,
                    timestamp: Date.now(),
                    status: 'pending'
                });
                db.ref(`users/${userId}/balance`).set(bal - amount);
                document.getElementById('withdraw-modal').classList.remove('active');
                document.getElementById('withdraw-amount').value = '';
                document.getElementById('withdraw-address').value = '';
            });
        };

        // Initial load
        showPage('home');
    </script>
</body>
</html>
