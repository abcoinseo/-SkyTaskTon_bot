<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyTaskTon - Earn TON</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Ad SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9789409' data-sdk='show_9789409'></script>
    <!-- TON Connect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <!-- Firebase -->
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, push, set, get, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBSj3t2ClyafHRgpN__cCnbDarhTfse3aA", // REPLACE WITH YOUR ACTUAL FIREBASE CONFIG
        authDomain: "skytasktonbot.firebaseapp.com",
        projectId: "skytasktonbot",
        storageBucket: "skytasktonbot.firebasestorage.app",
        messagingSenderId: "1078897344814",
        appId: "1:1078897344814:web:166f4341b884d877d97abf"
    };
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    window.firebase = { database, ref, push, set, get, onValue, remove, update };
    </script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* --- CSS (Same as previous, no changes needed for TON Pay integration itself) --- */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-color: #333;
        --light-text-color: #666;
        --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --card-background: rgba(255,255,255,0.98);
        --card-shadow: 0 8px 32px rgba(0,0,0,0.08);
        --card-hover-shadow: 0 16px 48px rgba(0,0,0,0.12);
        --input-border: #e1e5e9;
        --modal-backdrop: rgba(0,0,0,0.6);
        --modal-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--background-gradient); color: var(--text-color); overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 100vw; min-height: 100vh; position: relative; background: var(--card-background); backdrop-filter: blur(20px); display: flex; flex-direction: column; }
    .header { background: var(--primary-gradient); padding: 25px 20px; text-align: center; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; overflow: hidden; }
    .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>'); opacity: 0.3; }
    .header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 8px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); position: relative; z-index: 1; }
    .balance { font-size: 1.3em; margin-top: 15px; background: rgba(255,255,255,0.25); padding: 15px 20px; border-radius: 20px; backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.2); position: relative; z-index: 1; font-weight: 600; }
    .nav-tabs { display: flex; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #f0f0f0; }
    .nav-tab { flex: 1; padding: 18px 8px; text-align: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: none; background: none; font-size: 11px; display: flex; flex-direction: column; align-items: center; gap: 6px; font-weight: 500; position: relative; color: var(--light-text-color); }
    .nav-tab::before { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary-gradient); transform: scaleX(0); transition: transform 0.3s ease; }
    .nav-tab.active { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); color: var(--primary-color); }
    .nav-tab.active::before { transform: scaleX(1); }
    .nav-tab:hover { background: rgba(102, 126, 234, 0.05); transform: translateY(-1px); }
    .nav-tab .material-icons { font-size: 20px; }
    .tab-content { display: none; padding: 25px 20px; flex-grow: 1; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .task-card { background: white; border-radius: 20px; padding: 25px; margin: 20px 0; box-shadow: var(--card-shadow); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0,0,0,0.05); position: relative; overflow: hidden; }
    .task-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary-gradient); }
    .task-card:hover { transform: translateY(-8px); box-shadow: var(--card-hover-shadow); }
    .task-title { font-size: 1.4em; font-weight: 600; color: var(--text-color); margin-bottom: 12px; line-height: 1.3; }
    .task-description { color: var(--light-text-color); margin-bottom: 20px; line-height: 1.6; font-size: 0.95em; }
    .task-stats { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; }
    .stat { background: var(--primary-gradient); color: white; padding: 10px 16px; border-radius: 25px; font-size: 0.85em; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); display: flex; align-items: center; gap: 5px; }
    .btn { padding: 14px 28px; border: none; border-radius: 30px; cursor: pointer; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 10px; font-size: 1em; position: relative; overflow: hidden; }
    .btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
    .btn:hover::before { left: 100%; }
    .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5); }
    .btn-success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
    .btn-success:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(76, 175, 80, 0.5); }
    .btn-warning { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
    .btn-warning:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(255, 152, 0, 0.5); }
    .btn-danger { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4); }
    .btn-danger:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(244, 67, 54, 0.5); }
    .btn-info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4); }
    .btn-info:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(33, 150, 243, 0.5); }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-color); font-size: 0.95em; }
    .form-control { width: 100%; padding: 16px 20px; border: 2px solid var(--input-border); border-radius: 15px; font-size: 1em; transition: all 0.3s ease; background: white; font-family: inherit; color: var(--text-color); }
    .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); transform: translateY(-1px); }
    .profile-card { background: white; border-radius: 25px; padding: 35px; text-align: center; box-shadow: 0 12px 40px rgba(0,0,0,0.1); margin-bottom: 25px; position: relative; overflow: hidden; }
    .profile-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: var(--primary-gradient); }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: var(--primary-gradient); display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; color: white; font-size: 3.5em; box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3); }
    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: var(--modal-backdrop); backdrop-filter: blur(8px); animation: modalFadeIn 0.3s ease; }
    @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content { background-color: white; margin: 50px auto; padding: 35px; border-radius: 25px; width: 90%; max-width: 500px; box-shadow: var(--modal-shadow); animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
    @keyframes modalSlideIn { from { transform: translateY(-50px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .close { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; line-height: 1; }
    .close:hover { color: var(--primary-color); transform: scale(1.1); }
    .progress-bar { width: 100%; height: 12px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 15px 0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
    .progress-fill { height: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); position: relative; }
    .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    .ad-container { background: white; border-radius: 20px; padding: 30px; margin: 20px 0; text-align: center; box-shadow: var(--card-shadow); border: 1px solid rgba(0,0,0,0.05); }
    .ads-remaining { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px 25px; border-radius: 25px; display: inline-block; margin: 15px 0; font-weight: 600; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
    .countdown { font-size: 3em; font-weight: 700; color: var(--primary-color); margin: 25px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
    .notification { position: fixed; top: 25px; right: 25px; padding: 18px 25px; border-radius: 15px; color: white; font-weight: 600; z-index: 3000; animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 8px 25px rgba(0,0,0,0.2); max-width: 300px; text-align: center; }
    .notification.success { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .notification.error { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .notification.info { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
    @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin: 25px 0; }
    .stat-card { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: var(--card-shadow); transition: transform 0.3s ease; border: 1px solid rgba(0,0,0,0.05); }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 2.2em; font-weight: 700; color: var(--primary-color); margin-bottom: 8px; }
    .stat-label { font-size: 0.9em; color: var(--light-text-color); font-weight: 500; }
    .cost-display { background: var(--primary-gradient); color: white; padding: 20px; border-radius: 15px; margin: 20px 0; text-align: center; font-size: 1.2em; font-weight: 600; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); }
    .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 50px 20px; color: var(--light-text-color); }
    .empty-state .material-icons { font-size: 4em; color: #ddd; margin-bottom: 20px; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @media (max-width: 768px) {
        .header h1 { font-size: 2em; } .nav-tab { font-size: 10px; padding: 15px 5px; }
        .task-stats { flex-direction: column; align-items: stretch; }
        .stat { margin: 5px 0; }
        .modal-content { margin: 20px auto; width: 95%; padding: 25px; }
        .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
    }
    #home { padding-top: 15px; }
    #home h2 { margin-top: 30px; margin-bottom: 20px; }
    #ads .ad-container > .material-icons { font-size: 4em; color: var(--primary-color); margin-bottom: 20px; }
    #ads p strong { color: var(--primary-color); }
    #ads h3 { margin-bottom: 15px; color: var(--text-color); }
    #adDisplay { min-height: 350px; }
    #adContent { /* Placeholder styling */ }
    #paymentModal .modal-content { background: var(--primary-gradient); color: white; }
    #paymentModal .modal-content h2, #paymentModal .modal-content p { color: white !important; }
    #paymentModal .loading-spinner { border-top-color: white; border-color: rgba(255,255,255,0.5); }
    #verifyModal .modal-content .material-icons { color: var(--primary-color); }
    .developer-info { margin-top: 30px; padding: 20px; text-align: center; color: var(--light-text-color); font-size: 0.9em; border-top: 1px solid #eee; }
    .developer-info a { color: var(--primary-color); font-weight: 600; text-decoration: none; }
    .developer-info a:hover { text-decoration: underline; }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 SkyTaskTon</h1>
            <div class="balance">
                💎 Balance: <span id="userBalance">0.00000</span> TON
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">
                <span class="material-icons">home</span>
                <span>Home</span>
            </button>
            <button class="nav-tab" onclick="switchTab('tasks')">
                <span class="material-icons">assignment</span>
                <span>My Tasks</span>
            </button>
            <button class="nav-tab" onclick="switchTab('add-task')">
                <span class="material-icons">add_circle</span>
                <span>Add Task</span>
            </button>
            <button class="nav-tab" onclick="switchTab('ads')">
                <span class="material-icons">ads_click</span>
                <span>Ads</span>
            </button>
            <button class="nav-tab" onclick="switchTab('profile')">
                <span class="material-icons">person</span>
                <span>Profile</span>
            </button>
        </div>

        <!-- Home Tab -->
        <div id="home" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalEarnings">0.00000</div>
                    <div class="stat-label">Total Earned</div>
                </div>
            </div>
            <h2 style="margin-top: 30px; margin-bottom: 20px; font-size: 1.8em; color: var(--text-color);">🚀 Available Tasks</h2>
            <div id="allTasksList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- My Tasks Tab -->
        <div id="tasks" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">📝 My Tasks</h2>
            <div id="myTasksList">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Add Task Tab -->
        <div id="add-task" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">➕ Create New Task</h2>
            <form id="addTaskForm">
                <div class="form-group">
                    <label for="taskTitle">Task Title *</label>
                    <input type="text" id="taskTitle" class="form-control" placeholder="Enter an engaging task title" required>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Task Description *</label>
                    <textarea id="taskDescription" class="form-control" rows="4" placeholder="Describe what users need to do" required></textarea>
                </div>
                <div class="form-group">
                    <label for="taskUrl">Task URL *</label>
                    <input type="url" id="taskUrl" class="form-control" placeholder="https://example.com" required>
                </div>
                <div class="form-group">
                    <label for="totalImpressions">Total Impressions *</label>
                    <!-- Minimum impressions set to 500. Change min="50" if 50 is desired -->
                    <input type="number" id="totalImpressions" class="form-control" min="500" step="100" placeholder="Minimum 500 impressions" required>
                </div>
                <div class="cost-display">
                    💰 Total Cost: <span id="taskCost">0</span> TON
                    <div style="font-size: 0.9em; margin-top: 8px; opacity: 0.9;">
                        Rate: 500 impressions = 0.5 TON (This rate is for demonstration; actual cost will be calculated)
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="costProgress"></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    <span class="material-icons">payment</span>
                    Create Task & Pay with TON
                </button>
            </form>
        </div>

        <!-- Ads Tab -->
        <div id="ads" class="tab-content">
            <h2 style="margin-bottom: 25px; font-size: 1.8em; color: var(--text-color);">📺 Watch Ads & Earn</h2>
            <div class="ad-container">
                <div class="material-icons" style="font-size: 4em; color: var(--primary-color); margin-bottom: 20px;">play_circle_filled</div>
                <h3 style="margin-bottom: 15px;">Daily Ads Available</h3>
                <div class="ads-remaining">
                    <span id="adsRemaining">10</span> / 10 Ads Remaining
                </div>
                <p style="margin: 20px 0; color: var(--light-text-color); font-size: 1.1em;">
                    Earn <strong>0.000001</strong> TON per ad watched!
                </p>
                <button id="watchAdBtn" class="btn btn-success" style="font-size: 1.1em;">
                    <span class="material-icons">play_arrow</span>
                    Watch Ad Now
                </button>
                <div style="margin-top: 20px; font-size: 0.9em; color: #888;">
                    Ads reset daily at midnight
                </div>
            </div>
            <div id="adDisplay" style="display: none;" class="ad-container">
                <h3>Please wait while the ad loads...</h3>
                <div id="adContent" style="min-height: 200px; margin: 20px 0;"></div>
                <div class="countdown" id="adCountdown">5</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="adProgress"></div>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content">
            <div class="profile-card">
                <div class="profile-avatar">
                    <span class="material-icons">person</span>
                </div>
                <h2 id="userName" style="margin-bottom: 8px; font-size: 1.8em;">Loading...</h2>
                <p id="userId" style="color: var(--light-text-color); margin-bottom: 25px;">ID: Loading...</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="profileBalance">0.00000</div>
                        <div class="stat-label">TON Balance</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileTasks">0</div>
                        <div class="stat-label">Tasks Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileEarnings">0.00000</div>
                        <div class="stat-label">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="profileAdsWatched">0</div>
                        <div class="stat-label">Ads Watched</div>
                    </div>
                </div>
                <button id="withdrawBtn" class="btn btn-warning" style="margin-top: 20px; font-size: 1.1em;">
                    <span class="material-icons">account_balance_wallet</span>
                    Withdraw TON
                </button>
            </div>
            <div class="developer-info">
                Bot Developer: <a href="https://t.me/abstudioseo" target="_blank">@abstudioseo</a>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('withdrawModal')">&times;</span>
            <h2 style="margin-bottom: 25px; color: var(--text-color);">💰 Withdraw TON</h2>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawAmount">Amount (TON) *</label>
                    <input type="number" id="withdrawAmount" class="form-control" step="0.00001" min="0.001" placeholder="Minimum 0.001 TON" required>
                </div>
                <div class="form-group">
                    <label for="tonAddress">TON Wallet Address *</label>
                    <input type="text" id="tonAddress" class="form-control" placeholder="Enter your TON wallet address (starts with UQ)" required>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">
                    <span class="material-icons">send</span>
                    Submit Withdrawal Request
                </button>
            </form>
        </div>
    </div>

    <!-- Task Verification Modal -->
    <div id="verifyModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close" onclick="closeModal('verifyModal')">&times;</span>
            <div class="material-icons" style="font-size: 4em; color: var(--primary-color); margin-bottom: 20px;">hourglass_empty</div>
            <h2 style="margin-bottom: 20px; color: var(--text-color);">⏳ Task Verification</h2>
            <p style="margin-bottom: 25px; color: var(--light-text-color);">Please wait while we verify your task completion...</p>
            <div class="countdown" id="verifyCountdown">10</div>
            <div class="progress-bar">
                <div class="progress-fill" id="verifyProgress"></div>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="text-align: center; background: var(--primary-gradient); color: white;">
            <div class="material-icons pulse" style="font-size: 4em; color: white; margin-bottom: 20px;">payment</div>
            <h2 style="margin-bottom: 20px;">💳 Processing Payment</h2>
            <p style="margin-bottom: 25px; opacity: 0.9;">Connecting wallet and preparing transaction...</p>
            <div class="loading-spinner" style="border-top-color: white; border-color: rgba(255,255,255,0.5);"></div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let currentUser = null;
        let userTasks = {}; // Tasks created by the current user
        let allTasks = {}; // All available tasks from Firebase
        let userBalance = 0;
        let userStats = { tasksCreated: 0, tasksCompleted: 0, totalEarnings: 0, adsWatched: 0 };
        let adsWatchedToday = 0;
        let isProcessingPayment = false; // Prevent multiple payment requests
        let currentTab = 'home'; // Track the current active tab
        let taskVerificationInterval = null;
        let adCountdownInterval = null;

        // !!! IMPORTANT: REPLACE WITH YOUR ACTUAL TELEGRAM BOT USERNAME !!!
        const BOT_USERNAME = 'SkyTaskTonBot'; // <-- CHANGE THIS TO YOUR BOT'S USERNAME

        // --- TON CONNECT UI CONFIGURATION ---
        const TON_CONNECT_MANIFEST_URL = 'https://sky-task-ton-bot-compleat.vercel.app/tonconnect-manifest.json'; // URL where your manifest is hosted
        const TWA_RETURN_URL = 'https://t.me/start'; // URL to return to after transaction (Telegram Web App context)
        // IMPORTANT: Your bot backend MUST provide the destination TON address and the amount.
        // The frontend cannot securely know these values on its own.
        // For demonstration, we'll use placeholders. In a real app, get these from your backend.
        const PLACEHOLDER_BOT_TON_ADDRESS = 'EQABa48hjKzg09hN_HjxOic7r8T1PleIy1dRd8NvZ3922MP0'; // Replace with your bot's TON address

        // Initialize TON Connect UI
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: TON_CONNECT_MANIFEST_URL,
            buttonRootId: 'ton-connect', // This ID is not used by the library directly for UI, but for its own button logic.
                                         // We will manage the connect button separately.
            actionsConfiguration: {
                twaReturnUrl: TWA_RETURN_URL // Where to return after closing the modal in TWA
            }
        });

        // --- CONSTANTS ---
        const TASK_TON_COST_PER_500_IMPRESSIONS = 0.5; // TON cost per 500 impressions (adjust as needed)
        const TASK_TON_REWARD_PER_COMPLETION = 0.00005; // TON reward for completing a task
        const AD_TON_REWARD = 0.000001; // TON reward per watched ad
        const MAX_DAILY_ADS = 10;
        const AD_COUNTDOWN_SECONDS = 5;
        const TASK_VERIFICATION_SECONDS = 10;
        const SPECIAL_USER_ID_FOR_FREE_TASKS = 8101021767; // User ID for free task creation

        // --- INITIALIZATION ---
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
        window.Telegram.WebApp.enableClosingConfirmation();

        document.addEventListener('DOMContentLoaded', async function() {
            initializeUser();
            await loadUserData(); // Make sure user data is loaded before initializing TON Connect
            updateTaskCostInputHandler();
            initializeDailyAdsResetTimer();
            setupTabButtons();
            updateMainButton('home');
            await initializeTonConnect(); // Initialize TON Connect after user and basic data loaded
        });

        async function initializeTonConnect() {
            try {
                // Configure TON Connect UI for the app
                // This connects to the backend if needed for manifest validation etc.
                await tonConnectUI.init({
                    manifestUrl: TON_CONNECT_MANIFEST_URL,
                    actionsConfiguration: {
                        twaReturnUrl: TWA_RETURN_URL
                    }
                });

                // Setup a listener for connection status changes
                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        console.log("Wallet connected:", wallet.account.address);
                        // Update UI to show connected status, wallet address etc.
                        // You might want to save this wallet address for withdrawals later.
                        // Handle wallet connection UI updates here.
                        await updateUIForWalletConnected(wallet);
                        // Maybe also re-fetch user data if wallet connection should trigger something.
                    } else {
                        console.log("Wallet disconnected");
                        // Handle wallet disconnection UI updates.
                        await updateUIForWalletDisconnected();
                    }
                });

                // Check if a wallet is already connected (e.g., from previous session)
                const connectedWallet = await tonConnectUI.connectedOrchestrator.connectedWallet;
                if (connectedWallet) {
                    console.log("Wallet already connected:", connectedWallet.account.address);
                    await updateUIForWalletConnected(connectedWallet);
                } else {
                    console.log("No wallet connected.");
                    await updateUIForWalletDisconnected();
                }

            } catch (error) {
                console.error("TON Connect UI initialization failed:", error);
                showNotification("Failed to initialize TON wallet connection. Please try again.", "error");
            }
        }

        async function updateUIForWalletConnected(wallet) {
            // You can display the connected wallet address, enable payment buttons etc.
            // For now, just log it.
            console.log("Wallet UI updated for connected wallet.");
            // Example: Add a button to disconnect
            const profileTab = document.getElementById('profile');
            if (profileTab && !document.getElementById('disconnectWalletBtn')) {
                const disconnectBtn = document.createElement('button');
                disconnectBtn.id = 'disconnectWalletBtn';
                disconnectBtn.className = 'btn btn-secondary';
                disconnectBtn.style.marginTop = '10px';
                disconnectBtn.textContent = 'Disconnect Wallet';
                disconnectBtn.onclick = async () => {
                    await tonConnectUI.disconnect();
                    showNotification('Wallet disconnected.', 'info');
                    await updateUIForWalletDisconnected();
                };
                profileTab.querySelector('.profile-card').appendChild(disconnectBtn);
            }
        }

        async function updateUIForWalletDisconnected() {
            // Remove disconnect button if present
            const disconnectBtn = document.getElementById('disconnectWalletBtn');
            if (disconnectBtn) {
                disconnectBtn.remove();
            }
            // Ensure pay buttons are disabled/hidden if wallet not connected
        }


        // --- DATA LOADING AND UI UPDATING ---
        // ... (rest of loadUserData, updateUI, switchTab, createTaskCard, etc. remains the same) ...
        // EXCEPT for the payment initiation part.
        // The 'create task & pay' button will now trigger the TON Pay flow.


        // --- TASK MANAGEMENT - PAYMENT ---
        document.getElementById('addTaskForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isProcessingPayment) {
                showNotification('Payment already in progress...', 'info');
                return;
            }

            // Check if wallet is connected BEFORE proceeding
            if (!tonConnectUI.connectedOrchestrator.connectedWallet) {
                showNotification('Please connect your TON wallet first.', 'info');
                await tonConnectUI.openModal(); // Open wallet connection modal
                return;
            }

            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const url = document.getElementById('taskUrl').value.trim();
            const impressionsInput = document.getElementById('totalImpressions');
            const impressions = parseInt(impressionsInput.value);

            // Validation
            if (!title || !description || !url) {
                showNotification('Please fill in all required fields.', 'error');
                return;
            }
            if (impressions < 500) { // Minimum impressions check
                showNotification('Minimum 500 impressions required!', 'error');
                return;
            }
            if (!url.startsWith('http')) {
                 showNotification('Please enter a valid URL.', 'error');
                 return;
            }

            // Calculate TON cost (using the placeholder rate for demonstration)
            // A real system would get the exact TON amount and destination address from your bot backend.
            const estimatedTonCost = (impressions / 500) * TASK_TON_COST_PER_500_IMPRESSIONS;

            // --- Handle Free Task Creation Logic ---
            const isFreeTask = currentUser && currentUser.id === SPECIAL_USER_ID_FOR_FREE_TASKS;
            if (isFreeTask) {
                showNotification('Creating task for special user (free).', 'info');
                try {
                    // Call createTask without a transaction for free tasks
                    await createTask(title, description, url, 0, impressions, null); // costInTon = 0, transaction = null
                    showNotification('Task created successfully! 🎉', 'success');
                    document.getElementById('addTaskForm').reset();
                    document.getElementById('taskCost').textContent = '0';
                    document.getElementById('costProgress').style.width = '0%';
                } catch (error) {
                    console.error("Error creating free task:", error);
                    showNotification(`Error creating task: ${error.message}`, 'error');
                }
                return; // Exit after creating the free task
            }
            // --- End Free Task Creation Logic ---

            // --- TON Payment Initiation ---
            // THIS IS THE CRITICAL PART: Your bot backend MUST provide these details.
            // For demonstration, we're using hardcoded/estimated values.
            // You should fetch these from your backend via an API call.
            const transactionDetails = await getTransactionDetailsForTask(title, impressions); // Function to fetch details from backend

            if (!transactionDetails || !transactionDetails.address || !transactionDetails.amount) {
                showNotification("Could not get payment details from backend. Please try again later.", "error");
                return;
            }

            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600, // 10 minutes validity
                messages: [
                    {
                        address: transactionDetails.address, // Destination address (your bot's wallet)
                        amount: transactionDetails.amount // Toncoin in nanoton
                    }
                ]
            };

            console.log("Attempting to send TON transaction:", transaction);

            try {
                isProcessingPayment = true;
                document.getElementById('paymentModal').style.display = 'block';
                document.getElementById('paymentModal').querySelector('p').textContent = 'Please sign the transaction in your TON wallet...';

                const response = await tonConnectUI.sendTransaction(transaction);

                console.log("TON Transaction Response:", response);

                if (response.boc) { // 'boc' field indicates success in sending (not necessarily confirmed on-chain yet)
                    // The transaction was successfully sent to the wallet for signing.
                    // Now, your bot backend needs to monitor the blockchain for confirmation.
                    // For now, we'll assume success if the wallet accepted it.
                    await createTask(title, description, url, null, impressions, response.boc); // costInTon is not directly used here, but could be if you use it in Firebase

                    showNotification('Task created! Transaction sent for confirmation. 🎉', 'success');
                    document.getElementById('addTaskForm').reset();
                    document.getElementById('taskCost').textContent = '0';
                    document.getElementById('costProgress').style.width = '0%';
                    switchTab('home');
                } else {
                    // This case might be less common if sendTransaction throws an error first.
                    showNotification('TON transaction failed to send.', 'error');
                }
            } catch (error) {
                console.error("TON Transaction Error:", error);
                if (error.code === 'USER_REJECTED') {
                    showNotification('Wallet connection or transaction rejected by user.', 'info');
                } else {
                    showNotification(`TON transaction failed: ${error.message}`, 'error');
                }
            } finally {
                isProcessingPayment = false;
                closeModal('paymentModal');
            }
        });

        // Function to fetch transaction details from backend (REPLACE WITH YOUR API CALL)
        async function getTransactionDetailsForTask(taskTitle, impressions) {
            // In a real application, this would be an API call to your bot backend.
            // Your backend would:
            // 1. Get the user making the request (from JWT, session, or Telegram init data)
            // 2. Determine the TON cost for the task based on impressions and your pricing.
            // 3. Determine the TON destination address (your bot's wallet).
            // 4. Return an object like: { address: "...", amount: "123456789" } (amount in nanoton)

            // Simulating a backend response:
            const simulatedAmountNanoton = Math.round(TASK_TON_COST_PER_500_IMPRESSIONS * 1e9 * (impressions / 500)); // Example calculation

            console.log(`Simulating transaction details: ${impressions} impressions, cost ~${(simulatedAmountNanoton / 1e9).toFixed(9)} TON`);

            // Simulate a delay for fetching
            await new Promise(resolve => setTimeout(resolve, 500));

            return {
                address: PLACEHOLDER_BOT_TON_ADDRESS, // Use the placeholder or a dynamically fetched address
                amount: String(simulatedAmountNanoton) // Amount must be a string and in nanoton
            };
        }


        // --- Function to create task in Firebase (modified to handle TON transaction response) ---
        async function createTask(title, description, url, costInTon, totalImpressions, transactionBoc = null) {
            const taskId = `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const taskData = {
                id: taskId,
                title,
                description,
                url,
                totalImpressions: totalImpressions || parseInt(document.getElementById('totalImpressions').value),
                currentImpressions: 0,
                costInTon: costInTon, // Store cost if needed
                transactionBoc: transactionBoc, // Store transaction BOC for reference if needed
                rewardPerCompletion: TASK_TON_REWARD_PER_COMPLETION,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString(),
                status: 'active', // 'active', 'pending_confirmation', 'live', 'completed'
                completedBy: []
            };

            try {
                await firebase.set(firebase.ref(firebase.database, `tasks/${taskId}`), taskData);
                await firebase.set(firebase.ref(firebase.database, `userTasks/${currentUser.id}/${taskId}`), taskData);

                const updatedStats = {
                    ...userStats,
                    tasksCreated: userStats.tasksCreated + 1
                };
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/stats`), updatedStats);

            } catch (error) {
                console.error("Error saving task to Firebase:", error);
                throw error;
            }
        }

        // --- Other functions (displayAllTasks, displayMyTasks, completeTask, deleteTask, etc.) remain largely the same ---
        // You might need to adjust displayMyTasks and createTaskCard to show TON cost instead of Stars.
        // The reward calculation logic is also independent of payment method.

        // --- Placeholder for the rest of the functions (loadUserData, displayAllTasks, displayMyTasks, startTask, completeTask, deleteTask, modals, notifications, ads, etc.) ---
        // These functions generally remain the same as they handle UI, data display, and ad logic, not the payment mechanism.
        // Ensure 'showNotification', 'closeModal', 'updateUI', etc. are correctly defined and called.

        // --- Dummy implementations for functions that might need adjustments or are context-dependent ---
        async function loadUserData() {
            if (!currentUser) {
                console.error("No current user found. Cannot load user data.");
                return;
            }

            document.getElementById('allTasksList').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('myTasksList').innerHTML = '<div class="loading-spinner"></div>';

            const userRef = firebase.ref(firebase.database, `users/${currentUser.id}`);
            firebase.onValue(userRef, (snapshot) => {
                const userData = snapshot.val() || {};
                userBalance = userData.balance || 0; // Assuming balance is tracked in TON
                userStats = userData.stats || { tasksCreated: 0, tasksCompleted: 0, totalEarnings: 0, adsWatched: 0 };
                adsWatchedToday = userData.adsWatchedToday || 0;
                updateUI();
            }, (error) => {
                console.error("Error fetching user data:", error);
                showNotification("Failed to load user data.", "error");
            });

            const tasksRef = firebase.ref(firebase.database, 'tasks');
            firebase.onValue(tasksRef, (snapshot) => {
                allTasks = snapshot.val() || {};
                displayAllTasks();
            }, (error) => {
                console.error("Error fetching all tasks:", error);
                showNotification("Failed to load tasks.", "error");
            });

            const userTasksRef = firebase.ref(firebase.database, `userTasks/${currentUser.id}`);
            firebase.onValue(userTasksRef, (snapshot) => {
                userTasks = snapshot.val() || {};
                displayMyTasks();
            }, (error) => {
                console.error("Error fetching user tasks:", error);
                showNotification("Failed to load your tasks.", "error");
            });
        }

        function updateUI() {
            document.getElementById('userBalance').textContent = userBalance.toFixed(5);
            document.getElementById('profileBalance').textContent = userBalance.toFixed(5);
            document.getElementById('profileTasks').textContent = userStats.tasksCreated;
            document.getElementById('profileEarnings').textContent = userStats.totalEarnings.toFixed(5);
            document.getElementById('profileAdsWatched').textContent = userStats.adsWatched;

            const activeTasksCount = Object.values(allTasks).filter(task => task.status === 'active').length;
            document.getElementById('totalTasks').textContent = activeTasksCount;
            document.getElementById('completedTasks').textContent = userStats.tasksCompleted;
            document.getElementById('totalEarnings').textContent = userStats.totalEarnings.toFixed(5);

            document.getElementById('adsRemaining').textContent = Math.max(0, MAX_DAILY_ADS - adsWatchedToday);

            const watchAdBtn = document.getElementById('watchAdBtn');
            if (adsWatchedToday >= MAX_DAILY_ADS) {
                watchAdBtn.disabled = true;
                watchAdBtn.innerHTML = '<span class="material-icons">block</span>Daily Limit Reached';
                watchAdBtn.style.opacity = '0.6';
            } else {
                watchAdBtn.disabled = false;
                watchAdBtn.innerHTML = '<span class="material-icons">play_arrow</span>Watch Ad Now';
                watchAdBtn.style.opacity = '1';
            }
        }

        function setupTabButtons() {
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(button => {
                button.addEventListener('click', function() {
                    const tabId = this.getAttribute('onclick').match(/switchTab\('([^']+)'\)/)[1];
                    switchTab(tabId);
                });
            });
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            currentTab = tabName;
            updateMainButton(tabName);
        }

        function updateMainButton(tabName) {
            let buttonText = '';
            switch (tabName) {
                case 'home': buttonText = 'Home'; break;
                case 'tasks': buttonText = 'My Tasks'; break;
                case 'add-task': buttonText = 'Create Task'; break;
                case 'ads': buttonText = 'Watch Ads'; break;
                case 'profile': buttonText = 'My Profile'; break;
                default: buttonText = 'Back';
            }
            window.Telegram.WebApp.MainButton.setText(buttonText);
            window.Telegram.WebApp.MainButton.show();
        }

        async function startTask(taskId, url) {
            try {
                window.open(url, '_blank');
                document.getElementById('verifyModal').style.display = 'block';
                let countdown = TASK_VERIFICATION_SECONDS;
                const countdownElement = document.getElementById('verifyCountdown');
                const progressElement = document.getElementById('verifyProgress');
                progressElement.style.width = '0%'; countdownElement.textContent = countdown;
                if (taskVerificationInterval) clearInterval(taskVerificationInterval);
                taskVerificationInterval = setInterval(() => {
                    countdown--; countdownElement.textContent = countdown;
                    progressElement.style.width = ((TASK_VERIFICATION_SECONDS - countdown) / TASK_VERIFICATION_SECONDS) * 100 + '%';
                    if (countdown <= 0) { clearInterval(taskVerificationInterval); completeTask(taskId); closeModal('verifyModal'); }
                }, 1000);
            } catch (error) { console.error("Error starting task:", error); showNotification('Error starting task. Please try again.', 'error'); }
        }

        async function completeTask(taskId) {
            try {
                const task = allTasks[taskId];
                if (!task) { showNotification('Task not found!', 'error'); return; }
                if (task.completedBy?.includes(currentUser.id)) { showNotification('Task already completed by you!', 'info'); return; }
                const updatedTask = { ...task, currentImpressions: task.currentImpressions + 1, completedBy: [...(task.completedBy || []), currentUser.id] };
                await firebase.set(firebase.ref(firebase.database, `tasks/${taskId}`), updatedTask);
                const reward = task.rewardPerCompletion || TASK_TON_REWARD_PER_COMPLETION;
                const newBalance = userBalance + reward;
                const updatedStats = { ...userStats, tasksCompleted: userStats.tasksCompleted + 1, totalEarnings: userStats.totalEarnings + reward };
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/balance`), newBalance);
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/stats`), updatedStats);
                showNotification(`Task completed! +${reward.toFixed(5)} TON earned! 🎉`, 'success');
                loadUserData();
            } catch (error) { console.error('Error completing task:', error); showNotification('Error completing task. Please try again.', 'error'); }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task? This action cannot be undone.')) return;
            try {
                await firebase.remove(firebase.ref(firebase.database, `tasks/${taskId}`));
                await firebase.remove(firebase.ref(firebase.database, `userTasks/${currentUser.id}/${taskId}`));
                const updatedStats = { ...userStats, tasksCreated: Math.max(0, userStats.tasksCreated - 1) };
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/stats`), updatedStats);
                showNotification('Task deleted successfully!', 'success');
                loadUserData();
            } catch (error) { console.error("Error deleting task:", error); showNotification('Error deleting task. Please try again.', 'error'); }
        }

        async function earnFromAd() {
            try {
                const newBalance = userBalance + AD_TON_REWARD;
                const newAdsCount = adsWatchedToday + 1;
                const updatedStats = { ...userStats, totalEarnings: userStats.totalEarnings + AD_TON_REWARD, adsWatched: userStats.adsWatched + 1 };
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/balance`), newBalance);
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/adsWatchedToday`), newAdsCount);
                await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/stats`), updatedStats);
                showNotification(`Ad completed! +${AD_TON_REWARD.toFixed(6)} TON earned! 🎉`, 'success');
            } catch (error) { console.error('Error earning from ad:', error); showNotification('Error processing ad reward. Please try again.', 'error'); }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                if (modalId === 'verifyModal') {
                    if (taskVerificationInterval) { clearInterval(taskVerificationInterval); taskVerificationInterval = null; }
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s reverse forwards';
                setTimeout(() => { notification.remove(); }, 300);
            }, 3000);
        }

        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) { modal.style.display = 'none'; }
            });
        });

        function initializeDailyAdsResetTimer() {
            const now = new Date(); const tomorrow = new Date(now); tomorrow.setHours(0, 0, 0, 0); tomorrow.setDate(now.getDate() + 1);
            const msUntilMidnight = tomorrow.getTime() - now.getTime();
            setTimeout(async () => { await resetDailyAds(); setInterval(resetDailyAds, 24 * 60 * 60 * 1000); }, msUntilMidnight);
        }

        async function resetDailyAds() {
            if (currentUser) {
                try {
                    await firebase.set(firebase.ref(firebase.database, `users/${currentUser.id}/adsWatchedToday`), 0);
                    showNotification('Daily ads reset! You can watch 10 more ads today.', 'info');
                    loadUserData();
                } catch (error) { console.error("Error resetting daily ads:", error); showNotification("Failed to reset daily ads count.", "error"); }
            }
        }

        window.Telegram.WebApp.onEvent('mainButtonClicked', function() {
            const activeTabId = currentTab; console.log('Main button clicked in tab:', activeTabId);
        });

        window.Telegram.WebApp.onEvent('backButtonClicked', function() {
            if (currentTab !== 'home') { switchTab('home'); updateMainButton('home'); } else { window.Telegram.WebApp.close(); }
        });
        // --- END OF EXISTING FUNCTIONS ---

    </script>
</body>
</html>
